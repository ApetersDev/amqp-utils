#!/usr/bin/ruby

require 'rubygems'

gem 'trollop'
require 'trollop'

gem 'amqp'
require 'mq'

opts = Trollop::options do
  banner <<-END
Publishes a message to a particular queue.
  enqueue <queue> <message>
  
  END
  opt :verbose, 'Print all AMQP commands sent and received.'
  opt :persistent, 'Mark messages as persistent.'
  opt :count, 'Number of times the message should be published.', :type => :int, :default => 1
end

@queue = ARGV[0]
@message = ARGV[1]

EM.run do
  trap("INT") { AMQP.stop { EM.stop } }

  AMQP.logging = opts.verbose
  AMQP.start

  publisher = EM.spawn do |queue, message, messages|
    if messages > 0
      @mq ||= MQ.new
      @mq.queue(queue, :durable => true, :auto_delete => false).publish(message, :persistent => opts.persistent)
      print '.'; STDOUT.flush
      publisher.notify(queue, message, messages - 1)
    else
      EM.next_tick { AMQP.stop { EM.stop } }
    end
  end

  publisher.notify(@queue, @message, opts.count)
end
