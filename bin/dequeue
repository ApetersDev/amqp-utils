#!/usr/bin/ruby

require File.dirname(__FILE__) + '/../lib/amqp-utils/command'

@queues = ARGV

EM.run do
  trap("INT") { AMQP.stop { EM.stop } }

  @queues.each do |queue|
    puts "Dequeueing from #{queue}..."
    mq = MQ.new

    process_message = lambda do |header, message|
      puts "(#{queue})"
      puts "  Header: #{header.properties.inspect}"
      puts "  Message: #{message.inspect}"
    end
    mq.queue(queue).subscribe &process_message
  end
end
