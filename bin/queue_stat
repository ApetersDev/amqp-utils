#!/usr/bin/ruby

require 'rubygems'

gem 'trollop'
require 'trollop'

gem 'amqp'
require 'mq'

opts = Trollop::options do
  banner <<-END
Gets statistics on the queues specified.
  queue_stat <queue> [<another_queue> ..]
  
  END
  opt :verbose, 'Print all AMQP commands sent and received.'
end

@queues = ARGV

EM.run do
  AMQP.logging = opts.verbose

  @queues.each do |queue|
    MQ.new.queue(queue).status do |size, consumers|
      puts "Queue <#{queue}>: #{size} message(s), #{consumers} consumer(s)"

      @queues.delete(queue)
      AMQP.stop { EM.stop } if @queues.empty?
    end
  end
end
